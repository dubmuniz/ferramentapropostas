<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Gerador de Ficha de Identificação - Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="noindex">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
  <style>
    :root{--hb-green:#1E7E34;--hb-accent:#FFC857;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding-top:28px}
    .brand{display:inline-flex;align-items:center;gap:12px;justify-content:center}
    .logo{width:100px;height:auto}
    h1{margin:10px 0 6px;font-size:26px}
    p.lead{color:var(--muted);margin:0 0 10px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    label{display:block;margin:16px 0 6px;font-weight:600;color:var(--ink)}
    input,textarea{width:100%;margin-top:6px;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit;line-height:1.5}
    textarea{resize:vertical;min-height:120px}
    input[type=url]{word-break:break-all}
    button{background:var(--hb-green);color:#fff;border:0;border-radius:10px;padding:12px 24px;font-weight:600;cursor:pointer;transition:all .2s;font-size:16px;margin-top:20px;width:100%}
    button:hover:not(:disabled){filter:brightness(1.05)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn{display:inline-block;background:var(--hb-accent);color:#111;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600;margin-top:12px;text-align:center;width:100%}
    .btn:hover{filter:brightness(.95)}
    .hidden{display:none}
    .status{min-height:22px;color:var(--muted);margin:16px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:var(--hb-green)}
    footer{color:#80888c;font-size:12px;text-align:center;padding:24px 0}
    .note{font-size:12px;color:#80888c;margin-top:6px}
    .section-title{font-size:18px;font-weight:600;margin-top:24px;margin-bottom:12px;color:var(--ink)}
    .divider{height:1px;background:#e3e8ee;margin:20px 0}
    .result-preview{background:#f5f5f5;border-left:4px solid var(--hb-green);padding:16px;border-radius:8px;margin-top:16px}
    .result-preview h3{margin:0 0 12px;color:var(--hb-green)}
    .result-row{display:grid;grid-template-columns:250px 1fr;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #e3e8ee}
    .result-row:last-child{border-bottom:none}
    .result-label{font-weight:600;color:var(--ink)}
    .result-value{color:var(--muted);white-space:pre-wrap;word-break:break-word;line-height:1.6}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="brand">
      <img src="./Humana Logo.png" alt="Humana Logo" class="logo">
      <strong>Humana Povo para Povo Brasil</strong>
    </div>
    <h1>Gerador de Ficha de Identificação</h1>
    <p class="lead">Preencha os campos, a IA gera a ficha padronizada em português.</p>
  </header>

  <main class="wrap">
    <form id="fichForm" novalidate>
      <div class="section-title">Informações do Projeto</div>

      <label>Nome do Projeto *
        <input name="project_name" type="text" required maxlength="200" placeholder="Ex: Restauração Ecológica RJ 2026">
        <div class="note">Nome claro e objetivo</div>
      </label>

      <label>Link da Proposta ou Edital *
        <input name="proposal_url" type="url" required placeholder="https://exemplo.org/edital">
        <div class="note">Informe a página oficial quando possível</div>
      </label>

      <label>Arquivo do Edital ou Proposta, PDF DOCX DOC TXT, opcional
        <input type="file" id="editorialFile" accept=".pdf,.docx,.doc,.txt">
        <div class="note">Máximo 5 MB</div>
      </label>

      <label>Resumo Geral do Projeto *
        <textarea name="project_summary" required placeholder="Resumo em suas palavras, a IA melhora a fluência"></textarea>
      </label>

      <div class="divider"></div>

      <div style="text-align:center;margin-top:20px">
        <button type="submit" id="submitBtn">Gerar Ficha</button>
        <p id="status" class="status" role="status" aria-live="polite"></p>
      </div>

      <div id="result" class="hidden" style="margin-top:24px">
        <div class="result-preview" id="preview"></div>
        <a id="downloadLink" class="btn" href="#" download>Baixar Ficha em XLSX</a>
        <div class="note" style="margin-top:12px">Abra no Excel e edite se necessário</div>
      </div>
    </form>
  </main>

  <footer>© Humana Povo para Povo Brasil</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/je5qxm1aw515cjz6qm49dsbeesq73zci';

    function b64utf8(str){
      try{ return btoa(unescape(encodeURIComponent(String(str)))); }
      catch{ return ""; }
    }
    function sanitizePlain(str){
      return String(str||"")
        .replace(/[\u0000-\u001F\u007F]/g," ")
        .replace(/\r/g," ").replace(/\t/g," ")
        .replace(/\s+/g," ").trim();
    }

    // ------------------ Extrator de Datas (cliente) ------------------
    const PT_MONTHS = "(janeiro|fevereiro|março|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro)";
    const PT_MONTHS_ABBR = "(jan|fev|mar|abr|mai|jun|jul|ago|set|out|nov|dez)\\.?";
    const SEP = "[./\\-]";
    const ws = "\\s+";
    const DATE_PATTERNS = [
      new RegExp(`\\b\\d{1,2}${SEP}\\d{1,2}${SEP}\\d{2,4}\\b`, "gi"),
      new RegExp(`\\b\\d{4}${SEP}\\d{1,2}${SEP}\\d{1,2}\\b`, "gi"),
      new RegExp(`\\b\\d{1,2}${ws}de${ws}${PT_MONTHS}${ws}de${ws}\\d{4}\\b`, "gi"),
      new RegExp(`\\b\\d{1,2}${ws}(de${ws})?${PT_MONTHS_ABBR}(${ws}de)?${ws}\\d{4}\\b`, "gi"),
      new RegExp(`\\b\\d{1,2}${ws}a${ws}\\d{1,2}${ws}de${ws}${PT_MONTHS}${ws}de${ws}\\d{4}\\b`, "gi"),
      new RegExp(`\\b\\d{1,2}(?:\\s*[–-]\\s*|\\s+a\\s+)\\d{1,2}${SEP}\\d{1,2}${SEP}\\d{2,4}\\b`, "gi"),
      new RegExp(`\\b(\\d{1,2}${SEP}\\d{4}|${PT_MONTHS_ABBR}${SEP}\\d{4}|${PT_MONTHS}${ws}de${ws}\\d{4})\\b`, "gi"),
      new RegExp(`\\b(vig[eê]ncia|periodo|per[íi]odo|execu[cç][aã]o|at[eé]|prazo|deadline|submiss[aã]o|inscri[cç][aã]o)[:\\s]*\\d{4}\\b`, "gi")
    ];
    function unique(arr){ return Array.from(new Set(arr.map(s => s.trim()))); }
    function extractDateCandidates(text){
      const candidates = [];
      for(const re of DATE_PATTERNS){
        const matches = text.match(re);
        if(matches) candidates.push(...matches);
      }
      return unique(candidates).slice(0,200);
    }
    function extractDateContexts(text, candidates, radius=100){
      const lower = text.toLowerCase();
      const out = [];
      for(const cand of candidates){
        const idx = lower.indexOf(cand.toLowerCase());
        if(idx !== -1){
          const start = Math.max(0, idx - radius);
          const end = Math.min(text.length, idx + cand.length + radius);
          out.push({date:cand, context:sanitizePlain(text.substring(start, end))});
        }
      }
      return out.slice(0,200);
    }
    function makeDateHints(text){
      const cands = extractDateCandidates(text||"");
      if(!cands.length) return "";
      const ctxs = extractDateContexts(text||"", cands, 90);
      const lines = [];
      lines.push("HINTS_DE_DATAS");
      lines.push("CANDIDATOS: " + cands.join(" | "));
      if(ctxs.length){
        lines.push("CONTEXTOS:");
        for(const c of ctxs.slice(0,60)){
          lines.push(`- ${c.date} :: ${c.context}`);
        }
      }
      return "\n\n" + lines.join("\n") + "\n";
    }
    // ---------------------------------------------------------------

    async function extractTextFromFile(file){
      const statusEl = document.getElementById('status');
      try{
        statusEl.textContent = 'Processando arquivo';
        if(file.type === 'text/plain'){
          const text = await file.text();
          return text.substring(0,30000);
        }else if(file.type === 'application/pdf'){
          const arrayBuffer = await file.arrayBuffer();
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          let text = '';
          const maxPages = Math.min(pdf.numPages, 50);
          for(let i=1;i<=maxPages;i++){
            const page = await pdf.getPage(i);
            const tc = await page.getTextContent();
            text += tc.items.map(it=>it.str).join(' ') + ' ';
            if(text.length > 30000) break;
          }
          return text.trim().substring(0,30000);
        }else if(
          file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
          file.type === 'application/msword'
        ){
          const arrayBuffer = await file.arrayBuffer();
          const result = await mammoth.extractRawText({arrayBuffer});
          return result.value.trim().substring(0,30000);
        }
      }catch(e){
        console.error('Erro no arquivo', e);
        return '';
      }
    }

    const form = document.getElementById('fichForm');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const previewEl = document.getElementById('preview');
    const linkEl = document.getElementById('downloadLink');
    const btn = document.getElementById('submitBtn');

    function validURL(u){
      try{ const x=new URL(u); return ['http:','https:'].includes(x.protocol); }
      catch{ return false; }
    }

    function gerarXLSX(fichadata){
      const wb = XLSX.utils.book_new();
      const rows = [['Campo','Conteúdo']];
      for(const [key,value] of Object.entries(fichadata)){
        let displayValue = String(value||'').replace(/\\n/g,'\n');
        rows.push([key, displayValue]);
      }
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:40},{wch:100}];
      if(!ws['!rows']) ws['!rows']=[];
      ws['!rows'][0] = {hpx:30};
      for(let i=0;i<rows.length;i++){
        const A = 'A'+(i+1), B='B'+(i+1);
        ws[A] = ws[A]||{}; ws[B]=ws[B]||{};
        const style = {
          alignment:{wrapText:true,vertical:'top',horizontal:'left',shrinkToFit:false},
          font:{name:'Calibri',sz:11}
        };
        if(i===0){
          style.fill = {patternType:'solid', fgColor:{rgb:'1E7E34'}};
          style.font.bold = true; style.font.color = {rgb:'FFFFFF'};
          style.alignment.horizontal='center'; style.alignment.vertical='center';
        }else{
          const lines = (String(ws[B].v||'').match(/\n/g)||[]).length + 1;
          ws['!rows'][i] = {hpx: Math.max(25, lines*20)};
        }
        ws[A].s = style; ws[B].s = style;
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Ficha de Identificação');
      const fileName = `Ficha-Identificacao-${new Date().toLocaleString('pt-BR').replace(/[/:]/g,'-')}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    function mostrarPreview(fichadata){
      let html = '<h3>Prévia da Ficha</h3>';
      for(const [k,v] of Object.entries(fichadata)){
        const val = String(v||'').replace(/\n/g,'<br>').substring(0,800);
        html += `<div class="result-row"><div class="result-label">${k}</div><div class="result-value">${val}</div></div>`;
      }
      previewEl.innerHTML = html;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      btn.disabled = true;
      btn.textContent = 'Gerando';
      statusEl.textContent = '';
      statusEl.classList.remove('error','success');
      resultEl.classList.add('hidden');
      previewEl.innerHTML = '';

      try{
        const projectName = form.project_name.value.trim();
        const proposalUrl = form.proposal_url.value.trim();
        const projectSummary = form.project_summary.value.trim();
        if(!projectName || !proposalUrl || !projectSummary) throw new Error('Preencha os campos obrigatórios');
        if(!validURL(proposalUrl)) throw new Error('URL inválida');

        statusEl.textContent = 'Processando entrada';

        let extractedText = '';
        const fileInput = document.getElementById('editorialFile');
        if(fileInput && fileInput.files && fileInput.files[0]){
          extractedText = await extractTextFromFile(fileInput.files[0]);
        }else{
          extractedText = projectSummary;
        }

        // Injeta dicas de datas direto no texto enviado ao Claude (sem criar novos campos)
        const dateHints = makeDateHints(extractedText);
        const extractedTextWithHints = (extractedText || "") + (dateHints ? dateHints : "");

        const payload = {
          project_name: sanitizePlain(projectName),
          proposal_url: sanitizePlain(proposalUrl),
          project_summary: sanitizePlain(projectSummary),
          extracted_text: sanitizePlain(extractedTextWithHints),
          project_name_b64: b64utf8(projectName),
          proposal_url_b64: b64utf8(proposalUrl),
          project_summary_b64: b64utf8(projectSummary),
          extracted_text_b64: b64utf8(extractedTextWithHints),
          filled_at: new Date().toISOString().slice(0,10),
          type: 'ficha'
        };

        statusEl.textContent = 'Enviando para o Make';
        const res = await fetch(WEBHOOK_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(`Erro ${res.status} ${t}`);
        }

        let responseText = await res.text();
        let responseData;
        try{
          responseData = JSON.parse(responseText);
        }catch{
          const clean = responseText.replace(/```json\n?/g,'').replace(/```\n?/g,'').replace(/[\r\n\t]/g,' ').trim();
          responseData = JSON.parse(clean);
        }

        let fichadata = null;
        if(responseData?.ficha?.rows){
          fichadata = Object.fromEntries(responseData.ficha.rows.map(r=>[String(r.Campo||'').trim(), r.Conteúdo||'']));
        }else if(responseData?.ficha){
          fichadata = responseData.ficha;
        }else if(typeof responseData === 'object' && Object.keys(responseData).length>0){
          fichadata = responseData;
        }
        if(!fichadata || Object.keys(fichadata).length===0) throw new Error('Resposta sem dados de ficha');

        gerarXLSX(fichadata);
        mostrarPreview(fichadata);
        resultEl.classList.remove('hidden');
        statusEl.textContent = 'Ficha gerada com sucesso';
        statusEl.classList.add('success');
      }catch(err){
        statusEl.textContent = `Erro: ${err.message}`;
        statusEl.classList.add('error');
        console.error(err);
      }finally{
        btn.disabled = false;
        btn.textContent = 'Gerar Ficha';
      }
    });
  </script>
</body>
</html>

