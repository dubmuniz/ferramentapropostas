<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Humana Brasil ‚Äî Gerador de Ficha, Us to Us e Marco L√≥gico</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="noindex">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--hb-green:#1E7E34;--hb-accent:#FFC857;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding-top:28px}
    .brand{display:inline-flex;align-items:center;gap:12px;justify-content:center}
    .logo{width:44px;height:44px}
    h1{margin:10px 0 6px;font-size:26px}
    p.lead{color:var(--muted);margin:0 0 10px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    label{display:block;margin:12px 0;font-weight:600}
    input,textarea,select{width:100%;margin-top:6px;border:1px solid #d8dee4;border-radius:8px;padding:10px;font:inherit}
    input[type=url]{word-break:break-all}
    input[type=number]{width:100%}
    fieldset{border:1px solid #e3e8ee;border-radius:10px;padding:10px 12px;margin:14px 0}
    legend{font-weight:600;margin-bottom:8px}
    .checks{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
    .checks label{display:flex;align-items:center;gap:8px;margin:4px 0;font-weight:500}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row.full{grid-template-columns:1fr}
    .row-3col{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:720px){
      .row{grid-template-columns:1fr}
      .row-3col{grid-template-columns:1fr}
    }
    button{background:var(--hb-green);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;transition:all 0.2s}
    button:hover:not(:disabled){filter:brightness(1.05)}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .btn{display:inline-block;background:var(--hb-accent);color:#111;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600;margin-top:12px}
    .btn:hover{filter:brightness(0.95)}
    .hidden{display:none}
    .status{min-height:22px;color:var(--muted);margin:10px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:var(--hb-green)}
    footer{color:#80888c;font-size:12px;text-align:center;padding:24px 0}
    .note{font-size:12px;color:#80888c;margin-top:6px}
    .section-divider{margin:20px 0;padding:16px 0;border-top:1px solid #e3e8ee}
    .input-group{display:grid;grid-template-columns:1fr;gap:8px}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="brand">
      <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
        <circle cx="32" cy="32" r="30" fill="none" stroke="#1E7E34" stroke-width="4"/>
        <path d="M20 34c6-10 18-10 24 0M24 40c4-6 12-6 16 0" fill="none" stroke="#1E7E34" stroke-width="3" stroke-linecap="round"/>
      </svg>
      <strong>Humana Povo para Povo Brasil</strong>
    </div>
    <h1>Gerador de Ficha, Us to Us e Marco L√≥gico</h1>
    <p class="lead">Descreva seu projeto e gere automaticamente documentos estruturados em XLSX.</p>
  </header>

  <main class="wrap">
    <form id="docForm" novalidate>
      
      <!-- SE√á√ÉO 1: IDENTIFICA√á√ÉO DO PROJETO -->
      <fieldset>
        <legend>üìã Identifica√ß√£o do Projeto</legend>
        <div class="row">
          <label>T√≠tulo do projeto *
            <input name="title" required maxlength="140" placeholder="T√≠tulo curto e objetivo">
          </label>
          <label>Link do edital *
            <input name="edital_url" type="url" required placeholder="https://exemplo.org/chamada.pdf">
            <div class="note">Cole o link da chamada p√∫blica ou arquivo PDF</div>
          </label>
        </div>
        <div class="row">
          <label>P√∫blico-alvo
            <input name="target_audience" placeholder="Ex: Agricultores familiares de pequeno porte">
          </label>
          <label>Dura√ß√£o do Projeto (meses)
            <input name="duration" type="number" min="1" max="60" value="12" placeholder="Ex: 12">
          </label>
        </div>
      </fieldset>

      <!-- SE√á√ÉO 2: OBJETIVOS E RESULTADOS -->
      <fieldset>
        <legend>üéØ Objetivos e Resultados</legend>
        <label>Objetivo geral *
          <textarea name="obj_geral" required rows="3" placeholder="Defina a mudan√ßa central pretendida pelo projeto"></textarea>
        </label>

        <label>Objetivos espec√≠ficos *
          <textarea name="obj_espec" required rows="4" placeholder="Liste um objetivo por linha. Exemplo:&#10;- Aumentar acesso a tecnologias&#10;- Fortalecer organiza√ß√£o comunit√°ria&#10;- Melhorar renda mensal"></textarea>
        </label>

        <label>N√∫mero de Resultados Esperados
          <input name="num_results" type="number" min="1" max="10" value="3">
          <div class="note">Quantos resultados o projeto deve gerar?</div>
        </label>
      </fieldset>

      <!-- SE√á√ÉO 3: FORMATOS DE SA√çDA -->
      <fieldset>
        <legend>üìÑ Formatos de Sa√≠da</legend>
        <div class="checks">
          <label><input type="checkbox" name="outputs" value="ficha" checked> Ficha de Identifica√ß√£o</label>
          <label><input type="checkbox" name="outputs" value="ustuus" checked> Us to Us</label>
          <label><input type="checkbox" name="outputs" value="marcologico" checked> Marco L√≥gico</label>
        </div>
        <div class="note" style="margin-top:10px">Selecione quais formatos voc√™ deseja gerar</div>
      </fieldset>

      <!-- SE√á√ÉO 4: A√á√ÉO -->
      <div style="text-align:center;margin-top:20px">
        <button type="submit" id="submitBtn">Gerar XLSX</button>
        <p id="status" class="status" role="status" aria-live="polite"></p>
      </div>

      <!-- RESULTADO -->
      <div id="result" class="hidden" style="margin-top:20px;text-align:center">
        <a id="downloadLink" class="btn" href="#" download>‚¨áÔ∏è Baixar XLSX</a>
        <div class="note">O arquivo est√° pronto para download. Salve em seu computador.</div>
      </div>
    </form>
  </main>

  <footer>¬© Humana Povo para Povo Brasil | Prot√≥tipo em Desenvolvimento</footer>

 <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
// ‚ö†Ô∏è COPIE A URL DO WEBHOOK DO MAKE.COM E COLE AQUI:
const WEBHOOK_URL = 'COLOQUE_A_URL_DO_WEBHOOK_AQUI';

const form = document.getElementById('docForm');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const linkEl = document.getElementById('downloadLink');
const btn = document.getElementById('submitBtn');

function validURL(u) {
  try {
    const x = new URL(u);
    return ['http:', 'https:'].includes(x.protocol);
  } catch {
    return false;
  }
}

function aoaFromKeyRows(rows, headers) {
  const aoa = [headers];
  for (const r of rows) {
    aoa.push(headers.map(h => r[h] ?? ''));
  }
  return aoa;
}

function baixarXLSX(payload, nomeArquivo) {
  const wb = XLSX.utils.book_new();

  if (payload.ficha?.enabled) {
    const headers = ["Campo", "Conte√∫do"];
    const aoa = aoaFromKeyRows(payload.ficha.rows, headers);
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws['!cols'] = [{wch: 25}, {wch: 50}];
    XLSX.utils.book_append_sheet(wb, ws, "Ficha");
  }

  if (payload.ustuus?.enabled) {
    const headers = ["Se√ß√£o", "Texto"];
    const aoa = aoaFromKeyRows(payload.ustuus.rows, headers);
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws['!cols'] = [{wch: 20}, {wch: 55}];
    XLSX.utils.book_append_sheet(wb, ws, "UsToUs");
  }

  if (payload.marcologico?.enabled) {
    const headers = ["Objetivo Geral", "Objetivo Espec√≠fico", "Resultado", "Indicador", "Meta", "Linha de base", "Meio de Verifica√ß√£o", "Atividades", "Premissas/Riscos", "Cronograma", "Respons√°vel"];
    const aoa = aoaFromKeyRows(payload.marcologico.rows, headers);
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws['!cols'] = Array(11).fill({wch: 15});
    XLSX.utils.book_append_sheet(wb, ws, "MarcoLogico");
  }

  const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
  const blob = new Blob([wbout], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
  const url = URL.createObjectURL(blob);
  linkEl.href = url;
  linkEl.download = nomeArquivo;
  resultEl.classList.remove('hidden');
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  statusEl.textContent = '';
  statusEl.className = 'status';
  resultEl.classList.add('hidden');

  // Validar se WEBHOOK_URL foi configurada
  if (WEBHOOK_URL === 'COLOQUE_A_URL_DO_WEBHOOK_AQUI' || !WEBHOOK_URL) {
    statusEl.textContent = '‚ùå ERRO: Configure a URL do webhook no c√≥digo!';
    statusEl.classList.add('error');
    console.error('WEBHOOK_URL n√£o configurada!');
    return;
  }

  const data = new FormData(form);
  const outputs = Array.from(form.querySelectorAll('input[name="outputs"]:checked')).map(i => i.value);

  // Valida√ß√µes
  if (outputs.length === 0) {
    statusEl.textContent = '‚ö†Ô∏è Selecione ao menos um formato de sa√≠da.';
    statusEl.classList.add('error');
    return;
  }

  const editalURL = data.get('edital_url');
  if (!validURL(editalURL)) {
    statusEl.textContent = '‚ö†Ô∏è Informe um link v√°lido do edital (https://...).';
    statusEl.classList.add('error');
    return;
  }

  outputs.forEach(v => data.append('outputs[]', v));

  btn.disabled = true;
  btn.textContent = 'Gerando...';
  statusEl.textContent = '‚è≥ Enviando para Make.com...';
  statusEl.classList.add('success');

  console.log('Enviando dados para:', WEBHOOK_URL);
  console.log('Dados:', Object.fromEntries(data));

  try {
    // Converter FormData para JSON
    const jsonData = Object.fromEntries(data);
    console.log('Dados em JSON:', jsonData);

    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(jsonData)
    });

    console.log('Status:', res.status);

    if (!res.ok) {
      const errorText = await res.text().catch(() => 'Erro desconhecido');
      console.error('Erro da resposta:', errorText);
      throw new Error(`Make.com error ${res.status}: ${errorText}`);
    }

    const json = await res.json();
    console.log('Resposta recebida:', json);

    // Validar estrutura da resposta
    if (!json.ficha && !json.ustuus && !json.marcologico) {
      throw new Error('Resposta inv√°lida - estrutura n√£o reconhecida');
    }

    const titulo = (data.get('title') || 'documento').trim().replace(/[^\w\-]+/g, '_');
    baixarXLSX(json, `${titulo}_HumanaBrasil.xlsx`);
    statusEl.textContent = '‚úÖ Pronto para baixar!';
    statusEl.classList.add('success');

  } catch (err) {
    console.error('Erro completo:', err);
    statusEl.textContent = `‚ùå Erro: ${err.message}`;
    statusEl.classList.add('error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Gerar XLSX';
  }
});
</script>

</body>
</html>
